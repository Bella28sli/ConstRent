{% extends "base.html" %}
{% block title %}Клиенты{% endblock %}
{% block content %}
<div class="row g-3">
    <div class="col-12 col-lg-7">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-2 mb-3">
                    <h1 class="h4 mb-0">Клиенты</h1>
                    <form class="d-flex flex-wrap gap-2" method="get">
                        <input type="search" name="q" value="{{ filters.q }}" class="form-control form-control-sm" placeholder="Поиск по имени, email, телефону">
                        <select name="type" class="form-select form-select-sm">
                            <option value="">Все</option>
                            <option value="individual" {% if filters.type == "individual" %}selected{% endif %}>Физлица</option>
                            <option value="company" {% if filters.type == "company" %}selected{% endif %}>Юрлица</option>
                        </select>
                        <select name="sort" class="form-select form-select-sm">
                            <option value="recent" {% if filters.sort == "recent" %}selected{% endif %}>Сначала новые</option>
                            <option value="name" {% if filters.sort == "name" %}selected{% endif %}>По имени/названию</option>
                            <option value="email" {% if filters.sort == "email" %}selected{% endif %}>По email</option>
                        </select>
                        <button class="btn btn-accent btn-sm" type="submit">Применить</button>
                    </form>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Имя / Компания</th>
                                <th>Email</th>
                                <th>Телефон</th>
                                <th class="text-end">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for c in clients %}
                            <tr>
                                <td>
                                    <div class="fw-semibold">
                                        {% if c.type == "individual" %}
                                            {{ c.indclient.last_name }} {{ c.indclient.first_name }}
                                        {% else %}
                                            {{ c.compclient.company_name }}
                                        {% endif %}
                                    </div>
                                    <div>
                                        <span class="badge bg-secondary">
                                            {% if c.type == "individual" %}Физлицо{% else %}Юрлицо{% endif %}
                                        </span>
                                    </div>
                                </td>
                                <td>{{ c.email }}</td>
                                <td>{{ c.phone_number }}</td>
                                <td class="text-end">
                                    <a class="btn btn-outline-primary btn-sm" href="?edit_id={{ c.id }}">Изменить</a>
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="delete_id" value="{{ c.id }}">
                                        <button class="btn btn-outline-danger btn-sm" type="submit" onclick="return confirm('Удалить клиента?')">Удалить</button>
                                    </form>
                                </td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="4" class="text-center text-muted">Нет данных</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <h2 class="h5">{% if edit_id %}Редактирование клиента{% else %}Новый клиент{% endif %}</h2>
                <form method="post" class="mt-3">
                    {% csrf_token %}
                    {% if edit_id %}
                        <input type="hidden" name="edit_id" value="{{ edit_id }}">
                    {% endif %}
                    {% if base_form.non_field_errors %}
                        <div class="alert alert-danger">{{ base_form.non_field_errors }}</div>
                    {% endif %}
                    <div class="mb-3">
                        {{ base_form.email.label_tag }}
                        {{ base_form.email }}
                        {% if base_form.email.errors %}<div class="text-danger small">{{ base_form.email.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="mb-3">
                        {{ base_form.phone_number.label_tag }}
                        {{ base_form.phone_number }}
                        {% if base_form.phone_number.errors %}<div class="text-danger small">{{ base_form.phone_number.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="mb-3">
                        {{ base_form.type.label_tag }}
                        {{ base_form.type }}
                        {% if base_form.type.errors %}<div class="text-danger small">{{ base_form.type.errors|striptags }}</div>{% endif %}
                    </div>

                    <div class="border rounded p-3 mb-3 {% if detail_type != 'individual' %}d-none{% endif %}" id="individual-form">
                        <div class="fw-semibold mb-2">Физическое лицо</div>
                        {% for field in individual_form %}
                            <div class="mb-2">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}<div class="text-danger small">{{ field.errors|striptags }}</div>{% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    <div class="border rounded p-3 mb-3 {% if detail_type != 'company' %}d-none{% endif %}" id="company-form">
                        <div class="fw-semibold mb-2">Юридическое лицо</div>
                        {% for field in company_form %}
                            <div class="mb-2">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.errors %}<div class="text-danger small">{{ field.errors|striptags }}</div>{% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    <button class="btn btn-accent w-100" type="submit">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        const typeSelect = document.getElementById('client-type-select');
        const indiv = document.getElementById('individual-form');
        const comp = document.getElementById('company-form');
        function toggleForms() {
            const isCompany = typeSelect.value === 'company';
            comp.classList.toggle('d-none', !isCompany);
            indiv.classList.toggle('d-none', isCompany);
        }
        if (typeSelect && indiv && comp) {
            typeSelect.addEventListener('change', toggleForms);
            toggleForms();
        }
    })();
</script>
{% endblock %}
